language: cpp
sudo: false
dist: trusty
osx_image: xcode8.2

env:
  global:
   # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
   #   via the "travis encrypt" command using the project repo's public key
   - secure: "m+4GYWw4cqwuqm9If5bFt2pHLPIDbRr+FErwtav4m6f7RF0AYa79loJXLkZ0cJFl6x9XK2okwfJibz7M7RWB5hKPsYIuWHsdLPcTd+ipZDhH/KhICUdsot+avz+6zO8NtUrN8QCwAzXUr3ATYz6SLzYxpbJqehLZLv7yqoAQ7Za3X+Q5R+AIu8P2H5sAYYnSSp8GppNeJKXu2hFVxHrwwFWzWYlHJloCpuyZx4PDuGffUkedcbVcCDFvWBOAV3seY1zMza+s/SYBA8kLSGp4WuYQt8s5D50xQd5DVRwwzQ3U4+XvNZlBnvwzoPQVCH3DGiwU4V1hhiSQXQOlheEIuOTWEaiSQpRRSE/LnejewWLoG+5kMRXnccwphu8AzVtVqUBhmm5Vax3sB7h1u7YrKVt/rrNhk/ue1VyU2YbUVDfFvUw8iB9TlhMt3ZALq/cP81uq5lLsPOdFiQXu6BQfD7+Fc3Q4U3k859ioRsXDr5Wkb4csOUa/F4XkHZGxs+ZU5wJ+LkvdyuHDOyJFGopYafurdsuj9EscnZMKP1g1nUS9syqnF0Rpe7DrKCwLmF3yAvFeqkkbs2/bZA6chtujtZrocDyXqA/6VKPuQzqwyZC/AerVX/H7LhwjqS06tQzG6krW9uWJChKHpNk2Pp+7Ewv1Z/QdJDZqo7aPhptE07U="

addons:
  apt:
    packages:
      - g++-6
      - ninja-build
      - clang-3.9
      - lldb-3.9
    sources: &sources
      - ubuntu-toolchain-r-test
      - llvm-toolchain-trusty-3.9
  coverity_scan:
      project:
        name: "acgetchell/causal-sets-explorer"
        description: "Build submitted via Travis CI"
      notification_email: acgetchell@ucdavis.edu
      build_command_prepend: "mkdir build && cd build && conan install .. --build=missing"
      build_command:   "cmake -G Ninja -DCMAKE_BUILD_TYPE=Release .."
      branch_pattern: coverity-scan

os:
  - linux
  - osx

compiler:
  - gcc
  - clang

matrix:
  allow_failures:
    - os: linux
      compiler: gcc
    - os: osx
      compiler: gcc

before_install:
# Workaround for https://github.com/travis-ci/travis-ci/issues/6307
  - |
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      gpg2 --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
      rvm get stable --auto-dotfiles
      brew update
    fi
# Coverity
  - echo -n | openssl s_client -connect scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-


install:
#  - if [[ "${COMPILER}" != "" ]]; then export CXX=${COMPILER}; fi
  - |
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew unlink cmake
      brew upgrade cmake
      brew install gcc
      brew link --overwrite gcc
      brew install ninja
      brew install conan
    else
      CMAKE_URL="https://cmake.org/files/v3.8/cmake-3.8.1-Linux-x86_64.tar.gz"
      mkdir cmake && travis_retry wget --no-check-certificate --quiet -O - ${CMAKE_URL} | tar --strip-components=1 -xz -C cmake
      export PATH=${TRAVIS_BUILD_DIR}/cmake/bin:${PATH}
      pip install conan
    fi
  - cmake --version
  - if [[ "$CXX" = "g++" ]]; then export CXX="g++-6" CC="gcc-6"; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" && "$CXX" == "clang++" ]]; then export CXX="clang++-3.9" CC="clang-3.9"; fi

script:
  - |
    if [[ "${COVERITY_SCAN_BRANCH}" != 1 ]]; then
      mkdir build && cd build
      conan install .. --build=missing
      cmake -G Ninja -DCMAKE_BUILD_TYPE=Release ..
      cmake --build .

after_success:
  - (cd bin && ./causal_sets_explorer)
  - (cd bin && ./unittests)